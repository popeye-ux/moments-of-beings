---
import Layout from '../../../layouts/Layout.astro';
import Theme from '../../../layouts/Theme.astro';
import ArticleGrid from '../../../components/ArticleGrid.astro';
import Pagination from '../../../components/Pagination.astro';
import { getCollection } from 'astro:content';
import { entriesToPosts, publishedFilter, getPagination } from '../../../data/posts';
import { withBase } from '../../../utils/url';

export async function getStaticPaths() {
  const perPage = 9; // ← 直接在 function 內宣告，避免任何作用域怪問題
  const entries = await getCollection('blog', publishedFilter);
  const allPosts = entriesToPosts(entries);
  const totalPages = Math.max(1, Math.ceil(allPosts.length / perPage));

  return Array.from({ length: totalPages - 1 }, (_, i) => ({
    params: { page: String(i + 2) },
  }));
}

const perPage = 9;
const { page } = Astro.params;
const currentPage = Number(page) || 2;
const entries = await getCollection('blog', publishedFilter);
const allPosts = entriesToPosts(entries);
const { postsForPage, prevUrl, nextUrl } = getPagination(allPosts, currentPage, withBase('blog'), perPage);
---


<Layout title={`Blog (${currentPage}) | moment of beings`} description="moment of beings — Blog 文章列表">
  <Theme>
    <section class="blog-section" aria-label="Blog 文章列表">
      <ArticleGrid posts={postsForPage} />
      <Pagination previousUrl={prevUrl} nextUrl={nextUrl} />
    </section>
  </Theme>
</Layout>

<style>
  .blog-section {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 2rem;
  }

  @media (max-width: 600px) {
    .blog-section {
      padding: 0 1rem;
    }
  }
</style>
